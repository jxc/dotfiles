#!/bin/bash
#
# test-vm — Sandboxed dotfiles testing with Tart macOS VMs
#
# Usage:
#   script/test-vm setup   — Install Tart and pull macOS base image
#   script/test-vm test    — Automated: clone VM, run bootstrap, verify, cleanup
#   script/test-vm shell   — Interactive: clone VM, print SSH info, wait for Ctrl-C
#   script/test-vm ready   — Pre-bootstrapped: clone VM, bootstrap, defaults, wait

set -euo pipefail

DOTFILES_ROOT="$(cd "$(dirname "$0")/.." && pwd -P)"
BASE_IMAGE="ghcr.io/cirruslabs/macos-tahoe-base:latest"
LOCAL_IMAGE="macos-tahoe-base"
VM_NAME="dotfiles-test-$$"
VM_USER="admin"
VM_PASS="admin"
SSH_PORT=22

# ─── Helpers ──────────────────────────────────────────────────────────────────

info()    { printf "\r  [ \033[00;34m..\033[0m ] %s\n" "$1" >&2; }
success() { printf "\r\033[2K  [ \033[00;32mOK\033[0m ] %s\n" "$1" >&2; }
fail()    { printf "\r\033[2K  [\033[0;31mFAIL\033[0m] %s\n" "$1" >&2; exit 1; }

cleanup() {
  info "cleaning up VM '$VM_NAME'"
  tart stop "$VM_NAME" 2>/dev/null || true
  tart delete "$VM_NAME" 2>/dev/null || true
  success "VM cleaned up"
}

get_vm_ip() {
  tart ip "$VM_NAME" 2>/dev/null
}

wait_for_vm_boot() {
  local max_attempts=24
  local attempt=0

  info "waiting for VM to boot and get an IP address"
  while [ "$attempt" -lt "$max_attempts" ]; do
    local ip
    ip="$(get_vm_ip)" || true
    if [ -n "$ip" ]; then
      echo "$ip"
      return 0
    fi
    attempt=$((attempt + 1))
    sleep 5
  done
  fail "VM did not get an IP address after $((max_attempts * 5)) seconds"
}

wait_for_ssh() {
  local ip="$1"
  local max_attempts=36
  local attempt=0

  info "waiting for SSH to become ready at $ip"
  while [ "$attempt" -lt "$max_attempts" ]; do
    if nc -z -w 2 "$ip" "$SSH_PORT" 2>/dev/null; then
      # Give sshd a moment to fully initialize after port opens
      sleep 2
      success "SSH is ready"
      return 0
    fi
    attempt=$((attempt + 1))
    sleep 5
  done
  fail "SSH did not become ready after $((max_attempts * 5)) seconds"
}

# Run a command over SSH inside the VM using expect for password auth.
# expect ships with macOS — no extra dependencies needed.
ssh_cmd() {
  local ip="$1"
  shift
  local cmd="$*"

  expect -c "
    log_user 1
    set timeout 600
    spawn ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 $VM_USER@$ip \"$cmd\"
    expect {
      -re \"(P|p)assword:\" { send \"$VM_PASS\r\"; exp_continue }
      timeout { puts \"ERROR: ssh timed out\"; exit 1 }
      eof
    }
    catch wait result
    exit [lindex \$result 3]
  "
}

# Copy a file into the VM using scp + expect
scp_to_vm() {
  local ip="$1"
  local src="$2"
  local dst="$3"

  expect -c "
    log_user 1
    set timeout 600
    spawn scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 \"$src\" $VM_USER@$ip:$dst
    expect {
      -re \"(P|p)assword:\" { send \"$VM_PASS\r\"; exp_continue }
      timeout { puts \"ERROR: scp timed out\"; exit 1 }
      eof
    }
    catch wait result
    exit [lindex \$result 3]
  "
}

run_bootstrap() {
  info "running bootstrap"
  ssh_cmd "$VM_IP" "cd ~/.dotfiles && ./script/bootstrap" || fail "bootstrap failed"
  success "bootstrap completed"
}

run_set_defaults() {
  info "running macOS defaults"
  ssh_cmd "$VM_IP" "cd ~/.dotfiles && ./macos/set-defaults.sh 2>/tmp/set-defaults-stderr.log"
  if ssh_cmd "$VM_IP" "test -s /tmp/set-defaults-stderr.log"; then
    ssh_cmd "$VM_IP" "cat /tmp/set-defaults-stderr.log" >&2
    fail "set-defaults.sh produced errors on stderr"
  fi
  success "macOS defaults applied (no errors)"
}

print_ssh_banner() {
  echo ""
  echo "  ┌─────────────────────────────────────────────────────────┐"
  echo "  │  VM is ready! Connect with:                             │"
  echo "  │                                                         │"
  printf "  │  %-55s│\n" "ssh ${VM_USER}@${VM_IP}"
  printf "  │  %-55s│\n" "password: ${VM_PASS}"
  echo "  │                                                         │"
  echo "  │  Dotfiles are at: ~/.dotfiles                           │"
  echo "  │  Shared mount at: /Volumes/My Shared Files/dotfiles/    │"
  echo "  │                                                         │"
  echo "  │  Press Ctrl-C to stop and delete the VM                 │"
  echo "  └─────────────────────────────────────────────────────────┘"
  echo ""
}

# ─── VM Setup (shared between test and shell) ────────────────────────────────

# Sets VM_IP as a side effect (no subshell, so tart run & stays in main process group)
setup_vm() {
  info "cloning base image to '$VM_NAME'"
  tart clone "$LOCAL_IMAGE" "$VM_NAME"
  success "VM cloned"

  info "starting VM headless with dotfiles shared directory"
  tart run --no-graphics --dir="dotfiles:$DOTFILES_ROOT" "$VM_NAME" &

  VM_IP="$(wait_for_vm_boot)"
  info "VM IP: $VM_IP"

  wait_for_ssh "$VM_IP"

  info "cloning dotfiles repo from GitHub"
  local repo_url
  repo_url="$(git -C "$DOTFILES_ROOT" remote get-url origin)"
  # Convert SSH URL to HTTPS so the VM can clone without SSH keys
  repo_url="${repo_url/git@github.com:/https://github.com/}"
  ssh_cmd "$VM_IP" "git clone $repo_url ~/.dotfiles"
  success "repo cloned"

  info "overlaying local changes into VM"
  local tarball="/tmp/dotfiles-vm-$$.tar.gz"
  tar czf "$tarball" -C "$DOTFILES_ROOT" --exclude .git .
  # shellcheck disable=SC2088
  scp_to_vm "$VM_IP" "$tarball" "~/dotfiles.tar.gz"
  rm -f "$tarball"
  ssh_cmd "$VM_IP" "tar xzf ~/dotfiles.tar.gz -C ~/.dotfiles && rm ~/dotfiles.tar.gz"
  ssh_cmd "$VM_IP" "git -C ~/.dotfiles add -A"
  ssh_cmd "$VM_IP" "git -C ~/.dotfiles commit --allow-empty -m local-changes"
  success "local changes applied"

  info "pre-seeding git config to skip interactive prompts"
  ssh_cmd "$VM_IP" "git config --global user.name 'Test User'"
  ssh_cmd "$VM_IP" "git config --global user.email 'test@dotfiles.local'"
  ssh_cmd "$VM_IP" "git config --global dotfiles.managed true"
  success "git config seeded"
}

# ─── Subcommands ──────────────────────────────────────────────────────────────

cmd_setup() {
  info "checking for Tart"
  if ! command -v tart >/dev/null 2>&1; then
    info "installing Tart via Homebrew"
    brew install cirruslabs/cli/tart
    success "Tart installed"
  else
    success "Tart already installed"
  fi

  info "pulling base image (this may take a while on first run)"
  if tart list | grep -q "$LOCAL_IMAGE"; then
    success "base image '$LOCAL_IMAGE' already exists"
  else
    tart pull "$BASE_IMAGE"
    tart clone "$BASE_IMAGE" "$LOCAL_IMAGE"
    success "base image pulled and cloned to '$LOCAL_IMAGE'"
  fi
}

cmd_test() {
  if ! command -v tart >/dev/null 2>&1; then
    fail "Tart not found. Run 'make vm-setup' first."
  fi

  trap cleanup EXIT

  setup_vm
  run_bootstrap
  run_set_defaults

  info "running verification checks"
  ssh_cmd "$VM_IP" "cd ~/.dotfiles && ./script/verify" || fail "verification failed"
}

cmd_shell() {
  if ! command -v tart >/dev/null 2>&1; then
    fail "Tart not found. Run 'make vm-setup' first."
  fi

  trap cleanup EXIT

  setup_vm
  print_ssh_banner
  wait
}

cmd_ready() {
  if ! command -v tart >/dev/null 2>&1; then
    fail "Tart not found. Run 'make vm-setup' first."
  fi

  trap cleanup EXIT

  setup_vm
  run_bootstrap
  run_set_defaults
  print_ssh_banner
  wait
}

# ─── Main ─────────────────────────────────────────────────────────────────────

cmd_cleanup() {
  local count=0
  for vm in $(tart list 2>/dev/null | awk '/^local.*dotfiles-test-/{print $2}'); do
    info "stopping and deleting '$vm'"
    tart stop "$vm" 2>/dev/null || true
    tart delete "$vm" 2>/dev/null || true
    count=$((count + 1))
  done
  if [ "$count" -eq 0 ]; then
    success "no leftover test VMs found"
  else
    success "cleaned up $count test VM(s)"
  fi
}

case "${1:-}" in
  setup)   cmd_setup ;;
  test)    cmd_test ;;
  shell)   cmd_shell ;;
  ready)   cmd_ready ;;
  cleanup) cmd_cleanup ;;
  *)
    echo "Usage: script/test-vm {setup|test|shell|ready|cleanup}"
    echo ""
    echo "  setup    — Install Tart and pull macOS base image"
    echo "  test     — Automated: clone VM, run bootstrap, verify, cleanup"
    echo "  shell    — Interactive: clone VM, print SSH info, wait for Ctrl-C"
    echo "  ready    — Pre-bootstrapped: clone VM, bootstrap, defaults, wait"
    echo "  cleanup  — Stop and delete all leftover dotfiles-test-* VMs"
    exit 1
    ;;
esac
